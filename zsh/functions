#!/bin/zsh
##################################################################################################
#
#					 ____  _   _    _    ____ ___     _____   _    ____  _____ 
#					/ ___|| | | |  / \  |  _ \_ _|   |__  /  / \  |  _ \| ____|
#					\___ \| |_| | / _ \ | | | | |_____ / /  / _ \ | | | |  _|  
#					 ___) |  _  |/ ___ \| |_| | |_____/ /_ / ___ \| |_| | |___ 
#					|____/|_| |_/_/   \_\____/___|   /____/_/   \_\____/|_____|
#
#					https://github.com/ShadiZade
#					functions
#					zsh functions
#
###################################################################################################
####### symlink location: ~/.config/zsh/ ##########################################################
## terminal-art
source ~/Repositories/dotfiles/zsh/aliases
source ~/Repositories/scripts/essential-functions.sh
source ~/Repositories/private/private-aliases.sh

terminal-art () {
    last-updated
    touch "$usdd/qotd" "$usdd/today-date"
    [[ "$(cat "$usdd/today-date")" != "$(date +%m-%d)" ]] && {
	echolor green ":: Updating date..." 1
	date +"%m-%d" > "$usdd/today-date"
	echo -n > "$usdd/today-date-hijri"
	echo -n > "$usdd/today-date-french"
	fortune marxism > "$usdd/qotd"
	clear-line
    }
    [[ "$(cat "$usdd/today-date-utc")" != "$(TZ=UTC date +%m-%d)" ]] && {
	# vestigial test, useful to keep to track UTC time in the future
	TZ=UTC date +"%m-%d" > "$usdd/today-date-utc"
    }
    wifi-connected-p
     if [[ "$wc_p" -eq 0 ]] && [[ -z "$(cat "$usdd/today-date-french")" ]] 
     then
	 echolor green ":: Updating French Republican date..." 1 
	 ~/Repositories/scripts/french-republican-time.sh > "$usdd/today-date-french"
	 clear-line
     fi
     if [[ "$wc_p" -eq 0 ]] && [[ -z "$(cat "$usdd/today-date-hijri")" ]] 
     then
	 echolor green ":: Updating Hijri date..." 1 
	 ~/Repositories/scripts/hijri-date.sh > "$usdd/today-date-hijri"
	 clear-line
     fi
#    [[ "$(cat "$usdd/today-date")" != "$(TZ=GMT date +%m-%d)" ]] && {
	# what is this?
#	echo -n
 #   }
    echo -n "$(date +%A), $(date +"%d %B %Y")"
    [[ ! -z "$(cat "$usdd/today-date-hijri")" ]] && echo -n ", $(cat "$usdd/today-date-hijri")"
    echo
    cat "$usdd/today-date-french"
    ~/Repositories/communist-calendar/fetch-events.sh
    cat "$usdd/qotd" | cowsay -f none -W $(($(tput cols) - 10))
}

## disown
run_disowned () {
    "$@" & disown
}
rdo () {
    run_disowned "$@" 1>/dev/null 2>/dev/null
}

## bigdate
bd () {
    date +"%Y%m%d%H%M"
}

## pg
pg () {
    i=1
    while true;
    do echo -e "\033[31m:: Attempting...\033[0m ($i)"
       ping -qc 1 archlinux.org && break
       i=$((i+1))
       sleep 3
    done
}

## a
a () {
    mpv --no-audio-display --osd-fractions "$@"
}

## v
v () {
    rdo mpv --osd-fractions --audio-samplerate=88200 "$@"
}

## xpa
xpa () {
    pacman -Qq | fzf --preview 'pacman -Qil {}' --layout=reverse --bind 'enter:execute(pacman -Qil {} | less)'
}

## xpt
xpt () {
    [ -z "$1" ] && numpack="12" || numpack="$1"
    expac --timefmt='%Y-%m-%d %T' "%l\t%n-%v\t%w" | sort | grep explicit | sed 's/explicit//g' | tail -n "$numpack" 
}

## xpta
xpta () {
    [ -z "$1" ] && numpack="12" || numpack="$1"
    expac --timefmt='%Y-%m-%d %T' "%l\t%n-%v" | sort | tail -n "$numpack"
}

## key-names
key-names () {
	xev | awk -F'[ )]+' '/^KeyPress/ { a[NR+2] } NR in a { printf "%-3s %s\n", $5, $8 }'
}    

## alarm
alarm () {
    echolor yellow ":: Alarm set on â€œâ€œ$(date +%H:%M:%S)â€â€ for â€œâ€œ$1â€â€"
    echolor yellow ":: Wait for alarm..." 1
    sleep "$1" 2>/dev/null || {
	echo
	echolor red ":: â€œâ€œ$1â€â€ is an invalid value!"
	sfx ten-bloops
	return
    }
    printf '\r'
    echolor red-green ":: ALARM RINGING! IT'S â€œâ€œ$(date +%H:%M:%S)â€â€ NOW!" 
    quodlibet --pause
    mpv --loop-file=inf --really-quiet "$usdd/sounds/glass-hit.wav"
}

## knock
knock () {
    [ -z "$1" ] && knocker="URLLink.acsm" || knocker="$1"
    ~/.local/share/installed-scripts/knock/.knock/knock "$knocker"
}

## mk
mk () {
    mkdir -pv $(kebab "$@")
}

## delete-opf
delete-opf () {
    [ "$(pwd)" = "$HOME/Books/xadd" ] || return
    fd -q 'opf$' && move-to-trash-recursively *.opf
    fd -q 'jpg$' && move-to-trash-recursively *.jpg
    fd -q 'original_epub$' && move-to-trash-recursively *.original_epub
}

## detect-extra
detect-extra () {
    extra_dirs_exist=""
    extra_dirs="$(diff <(eza -1D ~) <(cat ~/.local/share/user-scripts/home-dirs) | tail -n +2 | tr '\n' ',' | sed 's/< //g;s/,$//g;s/,/ - /g')"
    [ -z "$extra_dirs" ] && return
    echo -e "\033[31m:: Extra dirs (\033[33m$extra_dirs\033[31m) exist in ~.\033[0m"
    extra_dirs_exist="y"
}
## k
k () {
    ~/Repositories/scripts/mpv-done.sh "$1"
}
## ..c
..c () {
    git add .
    git commit -m $(bd)
    tok
    change-prompt-for-git
}

## dr
dr () {
    for j in "${@}"
    do
	basename="$(random-string)"
	wget -nc --no-use-server-timestamps -O "$basename" -- "$j" || continue
	ext="$(extension-determiner "$basename")"
	[[ -z "$ext" ]] && {
	echolor red-aquamarine ":: File type for â€œâ€œ$basenameâ€â€ not detected. Please enter extension manually."
	echolor white ">>> " 1
	read -r ext
	    ext=".$ext"
    }
	mv "$basename" "$basename$ext"
    done
}

## lv
lv () {
    echo -e "\033[33m:: Showing a live feed of $(pwd | sed "s|$HOME|~|")\033[0m"
    while true; do
	lln
	sleep 1s
	tput cuu $(lln | wc -l)
    done
}
## wg
wg () {
    [[ -z "$2" ]] && {
	wget --continue --no-use-server-timestamps -nc -t 0 -- "$1"
    } || {
	outname="$(kebab "$2")"
	wget --continue --no-use-server-timestamps -O "$outname" -t 0 -- "$1" || return
	echolor yellow ":: Determining extension..."
	ext="$(extension-determiner "$outname")"
	[[ -z "$ext" ]] && {
	    echolor red ":: File type for â€œâ€œ$outnameâ€â€ not detected. Please enter extension manually."
	    echo -ne "\033[37m>>> \033[0m"
	    read -r ext
	    ext=".$ext"
	}
	mv "$outname" "$outname$ext"
    }
  #  sfx done 110
}

## netc
netc () {
    nmcli device disconnect wlp4s0 >/dev/null 2>/dev/null && {
	echolor green ":: Disconnected successfully."
    }
    sleep 1s
    wifi-connected-p
    # defined in /etc/zsh/zshenv
    echolor yellow ":: Connecting to network â€œâ€œ$DEFAULT_WIFI_NETWORKâ€â€"
    i=0
    found=1
    until [[ "$found" -eq 0 ]]
    do
	[[ -z "$DEFAULT_WIFI_PASSWORD" ]] && {
	    nmcli device wifi rescan
	    nmcli device wifi connect "$DEFAULT_WIFI_NETWORK" password "$DEFAULT_WIFI_PASSWORD" \
		  >/dev/null 2>/dev/null && found=0 || found=1
	} || {
 	    nmcli device wifi rescan
	    nmcli device wifi connect "$DEFAULT_WIFI_NETWORK" \
		  >/dev/null 2>/dev/null && found=0 || found=1
	}
	[[ "$found" -eq 1 ]] && {
	    ((i++))
	    clear-line
	    echolor red ":: No network named â€œâ€œ$DEFAULT_WIFI_NETWORKâ€â€ found. Retrying ($i)..." 1
	    sleep 1s
	}
	[[ "$found" -eq 0 ]] && {
	    clear-line
	    echolor green ":: Network â€œâ€œ$DEFAULT_WIFI_NETWORKâ€â€ connected after â€œâ€œ$iâ€â€ retries."
	}
    done
    wifi-connected-p
}

## cat-donefiles
cat-donefiles () {
    echo -e "$(cat * | sed 's/^/\\033[4\;37m/g;s/ is done on /\\033[0m is done on \\033[33m/g;s/$/\\033[0m/g')"
}

## fzf-dir
fzf-dir () {
    dir_list="$(eza $hide_flag -1DX --show-symlinks --no-quotes)"
    [ -z "$dir_list" ] \
	&& echo -e "\033[33m:: No directories.\033[0m" \
	&& return
    chosen_dir="$(echo "$dir_list" | fzf)"
    [ -z "$chosen_dir" ] \
	&& echo -e "\033[33m:: Nothing done.\033[0m" \
	&& return
    cd "$chosen_dir"
}


## ff
ff () {
    while true
    do
	fzf-dir
	[ -z "$chosen_dir" ] \
	    && break
	[ -z "$(eza $hide_flag -1D)" ] \
	    && break
    done
    ll
}

## submv
submv () {
    [ -z "$1" ] \
	&& whichsub=1 \
	    || whichsub="$1"
    eps=($(eza -1D -I renamed-subs))
    i=1
    mkdir "./renamed-subs"
    while [ "$i" -le "${#eps[@]}" ]; do
	curdir="${eps[$i]}"
	curep="$(eza -1 "$curdir" | tail -n +"$whichsub" | sed 1q)"
	cp "$curdir"/"$curep" ./renamed-subs/"$curdir".en.srt
	((i++))
    done
    echo -e "\033[33m:: Renamed the No. $whichsub subtitle files\033[0m"
}

â€™ () {
    dir="$1"
    [ -z "$1" ] \
	&& dir="."
    fl="$(eza --no-quotes -1fX --show-symlinks "$dir" | sed '/^$/d' | sort | fzf)"
    [ -z "$fl" ] && return
    file_ext="$(echo "$fl" | awk -F '.' '{print $NF}')"
    fw="$(echo "$dir/$fl")"
    realpath "$fl" | â†
    echo -e "\033[33m:: Opening \033[37m$fw\033[0m"
    case "$file_ext" in
	pdf|ps|djvu|epub)
	    rdo zathura "$fw" ;;
	mp3|wav|wmv|flv|flac|opus|ogg)
            mpv --no-audio-display "$fw" ;;
	mp4|mkv|ts|webm|ogv)
	    rdo mpv --osd-fractions --audio-samplerate=88200 "$fw" ;;
	jpg|png|jpeg|svg|jxl|jpeg_large|webp|gif|tif|avif|jp2)
	    rdo sxiv "$fw" ;;
	txt|md|org|tex|bib|sh|el|lisp|html|css)
	    bat "$fw" ;;
	csv)
	    csvlens "$fw" ;;
	*)
	    rdo xdg-open "$fw" ;;
    esac
}

xmm () {
    case "$1" in
	"") pkill kiod5
	    jmtpfs ~/.local/mobile/
	    ;;
	end) cd
	     umount ~/.local/mobile/
	     ;;
	*) echo ":: unknown command"
	   ;;
    esac
}

â†â†â† () {
    realpath "${1:-.}" | â†
    realpath "${1:-.}"
}

relevant () {
    [ -z "$1" ] && {
	fd -qH '.relevant-function.sh' \
	    && copyfile='.relevant-function.sh' \
		|| {
		echolor red ':: No relevant-function found'
		return
	    }
    } || {
	copyfile="$1"
    }
    cat "$copyfile" | â†n
    echolor yellow ":: Copied contents of â€œâ€œ$copyfileâ€â€ to clipboard."
}

function ren {
    echolor white "$(rename -van -- "$1" "$2" * || {echolor red ":: No results for â€œâ€œ$1â€â€"; return})"
    echolor yellow ":: Click <return> to continue."
    echo -n "> "
    read -r temp
    rename -va -- "$1" "$2" *
}

function pandocjk {
    [[ -z "$1" ]] && {
	echolor red ":: No input."
	return
    }
    [[ -z "$2" ]] && {
	echolor red ":: No output."
	return
    }
    cjk_font="$(fc-list :lang=zh | awk -F ':' '{print $2}' | awk -F ',' '{print $1}' | sort | uniq | fzf | sed 's/^ *//g')"
    [[ -z "$cjk_font" ]] && {
	echolor red ":: Font not chosen."
	return
    }
    echolor yellow-green ":: Using â€œâ€œ$cjk_fontâ€â€"
    pandoc --pdf-engine=xelatex -V mainfont="$cjk_font" "$1" -o "$2"
}

function â¨¯â¨¯ {
    move-to-trash-recursively $@
    echolor yellow ":: â€œâ€œ$number_of_files_trashedâ€â€ files trashed."
}

function determine-if-git-repo {
    fd --no-ignore -qHd 1 "^.git$" \
	&& export CUR_DIR_IS_GIT=1 \
		  || export CUR_DIR_IS_GIT=0
}

function change-prompt-for-git {
    green="#55ff55"
    pink="#ff55ff"
    blue="#34a7dd"
    case $(determine-if-git-repo; echo $CUR_DIR_IS_GIT) in
	0) PROMPT=" %F{$green}%2~%f %S%F{$green} å› %D{%H:%M} ğŸ ¦ %f%s " ;;
	1) [[ "$(git status -s | wc -l)" -gt 0 ]] \
	       && PROMPT=" %F{$pink}%2~%f %S%F{$pink} å› %D{%H:%M} ğŸ ¦ %f%s " \
		   || PROMPT=" %F{$blue}%2~%f %S%F{$blue} å› %D{%H:%M} ğŸ ¦ %f%s " ;;
	*) PROMPT=" %F{#ffffff}%2~%f %S%F{#ffffff} å› %D{%H:%M} ğŸ ¦ %f%s " ;;
    esac
}
	
function mkmd {
    projname="$(kebab "$@")"
    fontname="$(choose-font)"
    [[ -z "$projname" ]] && {
	echolor red ":: Please enter project name."
	return
    }
    [[ -e "$projname" ]] && {
	echolor red ":: â€œâ€œ$projnameâ€â€ already exists. Please choose another name."
	return
    }
    echolor yellow ":: Creating new markdown project â€œâ€œ$projnameâ€â€"
    mkdir "$projname"
    cd "$projname"
    cp ~/Misc/templates/markdown/* .
    sed -i "s/NAMEHERE/$projname/g;s/FONTHERE/$fontname/g" ./set.sh
    mv ./template.md ./"$projname".md
    git init
    git add -A
    git commit -m 'first commit'
    echolor yellow ":: Project â€œâ€œ$projnameâ€â€ created."
    cd - > /dev/null
}

function pdftoimg {
    [[ -z "$1" ]] && {
	echolor red ":: No input."
	return
    }
    burstdir="slides-"$(kebab "$1" | sed 's/-pdf//g')""
    mkdir ./"$burstdir"
    cd ./"$burstdir"
    pdftk ../"$1" burst output "$burstdir-" && {
	echolor yellow ":: PDF file burst into $(eza -1f "$burstdir"*pdf | wc -l) pages."
    }
    IFS=$'\n'
    i=1
    for j in *pdf
    do
	pdftoppm -jpeg "$j" "img-$(kebab "$j" | sed 's/-pdf//g')"
	echolor blue-yellow ":: Page no. â€œâ€œ$iâ€â€ converted."
	((i++))
    done
    unset IFS
}

function xmmv {
    [[ -z "$@" ]] && {
	echolor red ":: No input"
	return
    }
    â†’ "$@" ~/.local/mobile/Internal\ shared\ storage/Home/Desktop
}

function xmmb {
    â†’ ~/Books/xadd/* ~/.local/mobile/Internal\ shared\ storage/Books
}

function open-newsletter {
    loc="$HOME/Documents/newsletters"
    nlname="$(eza -1D "$loc" | fzf)"
    [[ -z "$nlname" ]] && return
    nlfile="$(eza -1f --sort=name "$loc"/"$nlname" | grep "pdf$" | tail -n 1)"
    echolor green ":: Opened newsletter â€œâ€œ${nlfile%'.'*}â€â€"
    zathura "$loc"/"$nlname"/"$nlfile" 2>/dev/null
}

function unread-newsletter {
    loc="$HOME/Documents/newsletters"
    ufile="$usdd/unread-newsletters"
    [[ -z "$(cat "$ufile")" ]] && {
	echolor yellow ":: No unread newsletters."
	return
    }
    nlfile="$(cat "$ufile" | awk -F '/' '{print $NF}' | awk -F '.' '{print $1}' | fzf)"
    [[ -z "$nlfile" ]] && return
    nlfilefull="$(grep "${nlfile}.pdf$" "$ufile")"
    echolor green ":: Opened newsletter â€œâ€œ$nlfileâ€â€"
    zathura "$nlfilefull" 2>/dev/null
    echolor yellow ":: Remove â€œâ€œ$nlfileâ€â€ from unread? (Y/n) " 1
    read -r remove_from_unread_p
    [[ "$remove_from_unread_p" = "n" ]] && {
	echolor red ":: â€œâ€œ$nlfileâ€â€ not removed."
    } || {
	sed -i "s|$nlfilefull||;/^$/d" "$ufile" && \
	    echolor green ":: â€œâ€œ$nlfileâ€â€ removed."
    }
}

function ws {
    [[ -z "$1" ]] && {
	wifi-connected-p
	echolor purple-yellow ":: Network: â€œâ€œ$DEFAULT_WIFI_NETWORKâ€â€\n:: Password: â€œâ€œ$DEFAULT_WIFI_PASSWORDâ€â€"
	[[ "$wc_p" -eq 0 ]] && {
	    echolor green ":: Currently connected to â€œâ€œ$(nmcli device status | grep '^wlp' | awk '{print $4}')â€â€"
	}
	echolor yellow ":: Reset to default? (y/N) " 1
	reset_p="n"
	read -r reset_p
	[[ "$reset_p" = "y" ]] && {
	    source ~/Repositories/private/wifi-creds.sh
	    echolor green ":: Default network reset to â€œâ€œ$DEFAULT_WIFI_NETWORKâ€â€"
	}
	return
    }
    export DEFAULT_WIFI_NETWORK="$1"
    export DEFAULT_WIFI_PASSWORD="$2"
    echolor green ":: Default network for netc command defined as â€œâ€œ$1â€â€"
    [[ -z "$2" ]] && {
	export DEFAULT_WIFI_PASSWORD=''
	echolor yellow ":: Network was defined without a password."
    }
}

function all-colors {
    IFS=$'\n'
    for j in $(xsv select -n 1 "$usdd"/echolors.csv)
    do
	eval echolor "$j" "$j"
    done
    unset IFS
}

random-file () {
    [[ "$(fd -d 1 "$1" | wc -l)" -eq 0 ]] && return
    fd -i -d 1 "$1" | sed -n "$(($(random-number 5) % $(fd -d 1 "$1" | wc -l) + 1))"p
}

function sl {
    [[ ! -z "$3" ]] && {
	echolor red ":: Error: more than two arguments!"
	return 1
    }
    [[ ! -e "$(realpath "$1")" ]] && {
	echolor red ":: â€œâ€œ$(realpath $1)â€â€ does not exist!"
	return 1
    }
    echolor purple-aquamarine ":: Linking â€œâ€œ$(realpath "$1")â€â€"
    echolor purple-aquamarine ":: To â€œâ€œ$(realpath "${2:-.}")â€â€"
    ln -s "$(realpath "$1")" "$(realpath "${2:-.}")"
}
# TODO convert all \033 to echolor

function last-updated {
    lud="$(tac /var/log/pacman.log | grep -m 1 'full system upgrade' | awk -F 'T' '{print $1}' | tr -d '[')"
    [[ "$(datediff -f %d $lud $(date +"%Y-%m-%d"))" -lt 2 ]] && return
    echolor beige-blue ":: System was last updated â€œâ€œ$(datediff -f %d $lud $(date +"%Y-%m-%d"))â€â€ days ago."
}

update-wsc () {
    spiderdir="$HOME/Study/academia/wsc"
    curspider="${${${$(fd -- spider-catalog "$spiderdir" | sort -Vr | sed 1q)##*-}%.*}:-19700101}"
    yester="$(date -d yesterday +"%Y%m%d")"
    [[ "$curspider" = "$yester" ]] && {
	echolor green-white ":: âœ“  â€œâ€œWorld Spider Catalogâ€â€ is up to date. Current edition: â€œâ€œ$curspiderâ€â€"
	return
    }
    echolor blue  ":: â¯â¯ Updating â€œâ€œWorld Spider Catalogâ€â€ now. " 1
    echolor red "$curspider â€œâ€œâ†’â€â€ " 1
    echolor green "$yester" 1
    wget --no-use-server-timestamps -O "$spiderdir/spider-catalog-$yester.csv" -nc -q -t 0 -- \
	  "https://wsc.nmbe.ch/resources/species_export_$yester.csv"
    clear-line
    echolor blue ":: âœ“  Updated â€œâ€œWorld Spider Catalogâ€â€: " 1
    echolor red "$curspider â€œâ€œâ†’â€â€ " 1
    echolor green "$yester"
    [[ "$(fd -- spider-catalog "$spiderdir" | wc -l)" -gt 9 ]] && {
	echolor beige-blue ":: There are too many versions of the WSC in â€œâ€œ$spiderdirâ€â€. Please clean."
    }
    unset spiderdir
}
